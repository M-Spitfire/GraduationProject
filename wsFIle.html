<!DOCTYPE html>
<html>
    <head>
        <meta charset="utf-8">
        <title>wsFile</title>
    </head>
    <body>
        <div class="container">
            <div class=" panel panel-defalut">
                <div class="panel-heading">分段读取文件：</div>
                <div class="panel-body">
                    <input type="file" id="file"><br>
                    <input type="button" value="中止" id="stop_button">
                    <input type="button" value="继续" id="continue_button">
                    <progress id="progressOne" style="width:400px" max="100" value="0"></progress>
                    <blockquote id="status" style="word-break:break-all"></blockquote>
                </div>
            </div>
        </div>
        <script>
            let fileBox = document.getElementById("file");
            //读取文件对象
            let reader = null;
            //每次读取的文件大小字节数
            let step = 1024;
            //当前已经读取的字节数
            let cuLoaded = 0;
            //当前读取的文件对象
            let file = null;
            //表示是否可以读取文件
            let enableRead = true;
            //记录当前文件字节总数
            let total;
            //标识开始上传实践
            let startTime = null;

            fileBox.onchange = function(){
                //获取文件对象
                file = this.files[0];
                total = file.size;
                console.info("文件大小：" + file.size);
                if(ws == null){
                    if(window.confirm("连接服务器失败，是否重连")){
                        createWebSocket(function(){
                            bindReader();
                        });
                    }
                    return;
                }
                bindReader();
            }

            //绑定reader
            function bindReader(){
                cuLoaded = 0;
                startTime = new Date();
                enableRead = true;
                reader = new FileReader();
                //成功读取第一部分
                reader.onload = function(e){
                    console.info("读取总数：" + e.loaded);
                    if(enableRead == false)return false;
                    //根据当前换种去来控制客户端读取速度
                    if(ws.bufferedAmount > step * 10){
                        setTimeout(function(){
                            //继续读取
                            console.log("---------->进入等待");
                            loadSuccess(e.loaded);
                        },3);
                    }
                    else{
                        loadSuccess(e.loaded);
                    }
                }
                readBlob();
            }

            //读取文件成功
            function loadSuccess(loaded){
                //将分段数据上传到服务器
                let blob = reader.result;
                //使用websocket服务器发送数据
                if(cuLoaded == 0){
                    ws.send(file.name);
                }
                ws.send(blob);
                //读取剩余部分
                cuLoaded += loaded;
                if(cuLoaded < total){
                    readBlob();
                } 
                else{
                    ws.send("END");
                    console.log("总共上传：" + cuLoaded + ",总共用时：" + (new Date().getTime() - startTime.getTime()) / 1000);
                }
                //显示结果
                let percent = (cuLoaded / total) * 100;
                document.getElementById("status").innerHTML = percent;
                document.getElementById("progressOne").value = percent;
            }

            //指定开始位置，分块读取文件
            function readBlob(){
                //指定开始位置和结束位置，读取文件
                let blob = file.slice(cuLoaded,cuLoaded + step);
                reader.readAsArrayBuffer(blob);
            }

            //中止
            let stop_btn = document.getElementById("stop_button");
            stop_btn.addEventListener("click", function(){
                console.info("中止，已加载字节数：" + cuLoaded);
                enableRead = false;
                reader.abort();
            })

            //continue
            let continue_btn = document.getElementById("continue_button");
            continue_btn.addEventListener("click", function(){
                console.info("继续，已加载字节数：" + cuLoaded);
                enableRead = true;
                readBlob();
            })

            let ws = null;
            function createWebSocket(onSuccess){
                let url = "ws://192.168.43.42:8080/WEB/websocket"
                ws = new WebSocket(url);
                ws.onopen = function(e){
                    console.log("connected succeed!");
                    if(onSuccess){
                        onSuccess();
                    }
                }
                ws.onmessage = function(e){
                    let data = e.data;
                    if(isNaN(data)==false){
                        console.info("data is nan");
                    }
                    else{
                        console.info(data);
                    }
                }
                ws.onclose = function(e){
                    stop();
                    console.info("connection closed!");
                }
                ws.onerror = function(e){
                    stop();
                    console.info(e);
                    console.log("ERROR!!!");
                }
            }
            createWebSocket();
        </script>
    </body>
</html>